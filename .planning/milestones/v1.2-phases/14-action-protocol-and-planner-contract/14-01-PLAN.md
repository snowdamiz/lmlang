---
phase: 14-action-protocol-and-planner-contract
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/lmlang-server/src/schema/autonomy_plan.rs
  - crates/lmlang-server/src/schema/mod.rs
  - crates/lmlang-server/src/lib.rs
  - docs/api/operator-endpoints.md
autonomous: true
requirements:
  - AUT-02
  - AUT-03

must_haves:
  truths:
    - "Planner response contract is versioned and represented by explicit Rust schema types"
    - "Server-side plan validation exists before any autonomous execution routing"
    - "Contract supports ordered multi-step actions for graph edits and tool calls"
    - "Validation returns structured, machine-readable failure reasons"
  artifacts:
    - path: "crates/lmlang-server/src/schema/autonomy_plan.rs"
      provides: "Versioned planner envelope, action variants, and semantic validation helpers"
      min_lines: 180
    - path: "crates/lmlang-server/src/schema/mod.rs"
      provides: "Public schema module export for autonomy planner contract"
      contains: "autonomy_plan"
    - path: "docs/api/operator-endpoints.md"
      provides: "Planner contract documentation and field-level behavior notes"
      contains: "planner"
  key_links:
    - from: "crates/lmlang-server/src/schema/autonomy_plan.rs"
      to: "crates/lmlang-server/src/schema/mutations.rs"
      via: "Mutate-batch planner action references existing mutation request semantics"
      pattern: "Mutation|ProposeEditRequest"
    - from: "crates/lmlang-server/src/schema/autonomy_plan.rs"
      to: "crates/lmlang-server/src/schema/verify.rs"
      via: "Verify planner action maps to existing verify request/response scope"
      pattern: "Verify"
    - from: "docs/api/operator-endpoints.md"
      to: "crates/lmlang-server/src/schema/autonomy_plan.rs"
      via: "API docs mirror source-of-truth planner schema versioning and validation"
      pattern: "version"
---

<objective>
Define the Phase 14 planner contract and validation foundation.

Purpose: Introduce a strict, versioned action-plan schema that the server can parse and validate deterministically.
Output: New autonomy planner schema module with semantic validators and API documentation aligned to AUT-02/AUT-03.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/14-action-protocol-and-planner-contract/14-RESEARCH.md
@crates/lmlang-server/src/schema/mod.rs
@crates/lmlang-server/src/schema/mutations.rs
@crates/lmlang-server/src/schema/verify.rs
@crates/lmlang-server/src/schema/compile.rs
@docs/api/operator-endpoints.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create versioned planner schema envelope and action model</name>
  <files>
    crates/lmlang-server/src/schema/autonomy_plan.rs
    crates/lmlang-server/src/schema/mod.rs
    crates/lmlang-server/src/lib.rs
  </files>
  <action>
    Add a new schema module that defines:
    - explicit planner contract version identifier(s)
    - top-level plan envelope with goal, ordered actions, metadata, and optional structured failure
    - action variants that cover multi-step graph/tool workflows (mutation batch, verify, compile, simulate, inspect/history)
    - serde behavior that enforces strict JSON compatibility and predictable defaults

    Export the module through schema/lib surfaces so handler and runner code can consume it.
  </action>
  <verify>
    `cargo test --package lmlang-server` passes with new schema unit tests covering parse/serialize behavior.
  </verify>
  <done>
    Planner contract exists as first-class Rust types with explicit versioning and multi-step action support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement semantic validation and document contract rules</name>
  <files>
    crates/lmlang-server/src/schema/autonomy_plan.rs
    docs/api/operator-endpoints.md
  </files>
  <action>
    Add semantic validation helpers that reject malformed plans before execution, including:
    - unsupported version
    - invalid empty/oversized action sequences
    - action payload shape violations
    - missing required fields for each action type

    Document the planner contract in API docs with:
    - versioning strategy
    - required/optional fields
    - structured failure reason codes and validation error semantics.
  </action>
  <verify>
    Validation tests cover both valid multi-step plans and invalid contract cases with explicit error codes/messages.
  </verify>
  <done>
    Server has enforceable, documented planner validation semantics ready for routing integration.
  </done>
</task>

</tasks>

<verification>
1. New autonomy planner schema module compiles and is exported through `schema/mod.rs`
2. Planner envelope includes explicit version field and ordered multi-step actions
3. Validation helper rejects unsupported version and malformed action payloads
4. Validation helper returns structured reason data consumable by handlers
5. API docs include planner contract fields, version policy, and failure semantics
</verification>

<success_criteria>
- AUT-02 foundation is complete (versioned schema + server validation)
- AUT-03 contract support exists for multi-step edits/tool actions
- Planner contract is documented and ready for runtime integration in Plan 14-02
</success_criteria>

<output>
After completion, create `.planning/phases/14-action-protocol-and-planner-contract/14-01-SUMMARY.md`
</output>
