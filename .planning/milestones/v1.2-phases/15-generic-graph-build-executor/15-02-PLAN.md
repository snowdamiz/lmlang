---
phase: 15-generic-graph-build-executor
plan: 02
type: execute
wave: 2
depends_on:
  - "15-01"
files_modified:
  - crates/lmlang-server/src/autonomous_runner.rs
  - crates/lmlang-server/src/handlers/agent_control.rs
  - crates/lmlang-server/src/handlers/dashboard.rs
  - crates/lmlang-server/src/schema/agent_control.rs
  - crates/lmlang-server/src/schema/dashboard.rs
  - crates/lmlang-server/src/project_agent.rs
autonomous: true
requirements:
  - AUT-05
  - AUT-06

must_haves:
  truths:
    - "Autonomous runner performs bounded plan/apply/verify/replan iterations instead of stopping on first planner acceptance"
    - "Retry behavior is deterministic and governed by explicit attempt budget rules"
    - "Terminal run states always include explicit stop reason code plus actionable detail"
    - "Agent and dashboard chat surfaces expose autonomous execution outcome metadata for operator inspection"
  artifacts:
    - path: "crates/lmlang-server/src/autonomous_runner.rs"
      provides: "Bounded autonomy loop orchestration using planner + executor outcomes with deterministic retry transitions"
      min_lines: 260
    - path: "crates/lmlang-server/src/schema/agent_control.rs"
      provides: "Chat/session response fields for autonomous terminal reason and execution evidence summaries"
      contains: "stop_reason"
    - path: "crates/lmlang-server/src/schema/dashboard.rs"
      provides: "Dashboard AI response projection for execution metadata"
      contains: "execution"
    - path: "crates/lmlang-server/src/handlers/agent_control.rs"
      provides: "Projection logic for structured autonomous execution outcomes into chat responses/transcript behavior"
      contains: "execution"
  key_links:
    - from: "crates/lmlang-server/src/autonomous_runner.rs"
      to: "crates/lmlang-server/src/autonomy_executor.rs"
      via: "Runner executes accepted planner actions through shared executor and consumes typed outcomes"
      pattern: "execute|outcome|attempt"
    - from: "crates/lmlang-server/src/autonomous_runner.rs"
      to: "crates/lmlang-server/src/autonomy_planner.rs"
      via: "Planner outcome classification drives retry and terminal transitions in run loop"
      pattern: "PlannerOutcome|Rejected|Accepted"
    - from: "crates/lmlang-server/src/handlers/dashboard.rs"
      to: "crates/lmlang-server/src/schema/dashboard.rs"
      via: "Dashboard AI chat responses include structured autonomous execution metadata"
      pattern: "execution|stop_reason|attempt"
---

<objective>
Integrate executor foundation into the autonomous runtime loop with bounded retries.

Purpose: Deliver AUT-05 loop behavior and AUT-06 operator-visible terminal outcomes.
Output: Runner and API response integration that executes accepted plans, retries deterministically, and exposes stop reasons/evidence.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/15-generic-graph-build-executor/15-RESEARCH.md
@.planning/phases/15-generic-graph-build-executor/15-01-PLAN.md
@crates/lmlang-server/src/autonomous_runner.rs
@crates/lmlang-server/src/autonomy_planner.rs
@crates/lmlang-server/src/handlers/agent_control.rs
@crates/lmlang-server/src/handlers/dashboard.rs
@crates/lmlang-server/src/schema/agent_control.rs
@crates/lmlang-server/src/schema/dashboard.rs
@crates/lmlang-server/src/project_agent.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace planner-accept-stop behavior with bounded plan/apply/verify/replan loop</name>
  <files>
    crates/lmlang-server/src/autonomous_runner.rs
    crates/lmlang-server/src/project_agent.rs
  </files>
  <action>
    Refactor autonomous loop transitions so accepted planner outcomes execute actions through the phase15 executor, then continue according to bounded retry policy.
    Implement deterministic loop states:
    - planner rejected (retryable/non-retryable)
    - action execution success/failure
    - verify gate outcome
    - retry budget exhaustion
    - successful completion

    Ensure each terminal path records explicit stop reason code and concise detail message, not only free-form text.
  </action>
  <verify>
    Focused tests confirm loop exits correctly for success, retry exhaustion, and non-retryable planner/action failures with stable stop reason codes.
  </verify>
  <done>
    AUT-05 loop control is implemented with bounded deterministic behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expose execution outcome metadata to agent and dashboard chat APIs</name>
  <files>
    crates/lmlang-server/src/schema/agent_control.rs
    crates/lmlang-server/src/schema/dashboard.rs
    crates/lmlang-server/src/handlers/agent_control.rs
    crates/lmlang-server/src/handlers/dashboard.rs
  </files>
  <action>
    Extend response schemas and projection logic so operators can inspect autonomous run outcomes directly from chat endpoints.
    Include fields for:
    - terminal stop reason code/message
    - attempt count and retry budget status
    - compact action execution summaries (latest attempt)

    Keep backward compatibility for existing response consumers where possible (optional fields, stable existing keys).
  </action>
  <verify>
    Integration-level assertions confirm agent chat and dashboard chat include execution metadata when autonomous runs finish or stop.
  </verify>
  <done>
    AUT-06 operator visibility is available on main chat control surfaces.
  </done>
</task>

</tasks>

<verification>
1. Autonomous runner no longer idles immediately on `PlannerOutcome::Accepted`
2. Retry budget behavior is explicit and deterministic across planner and executor failures
3. Terminal run status includes machine-readable stop reason code in session-visible data
4. Agent and dashboard API responses project autonomous execution metadata as optional structured fields
5. Existing explicit command path (`create/compile/run hello world`) remains functional
</verification>

<success_criteria>
- AUT-05 satisfied: bounded plan/apply/verify/replan loop is running in autonomous execution path
- AUT-06 satisfied for runtime surfaces: stop reasons + evidence are inspectable through APIs/transcript
- Runner behavior is robust enough to support phase16 verify/compile repair extensions
</success_criteria>

<output>
After completion, create `.planning/phases/15-generic-graph-build-executor/15-02-SUMMARY.md`
</output>
