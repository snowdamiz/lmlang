---
phase: 15-generic-graph-build-executor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/lmlang-server/src/autonomy_executor.rs
  - crates/lmlang-server/src/schema/autonomy_execution.rs
  - crates/lmlang-server/src/schema/mod.rs
  - crates/lmlang-server/src/lib.rs
  - crates/lmlang-server/src/project_agent.rs
autonomous: true
requirements:
  - AUT-04
  - AUT-06

must_haves:
  truths:
    - "Validated planner actions are executable through deterministic server-side dispatch without keyword-chat heuristics"
    - "Executor returns typed per-action results (success/failure, action index, summary/error) for transcript/API projection"
    - "Terminal stop reasons use explicit machine-readable codes with structured detail payloads"
    - "Mutating actions continue to rely on existing ProgramService validation/atomic commit semantics"
  artifacts:
    - path: "crates/lmlang-server/src/autonomy_executor.rs"
      provides: "Generic action dispatcher mapping planner action variants to ProgramService operations"
      min_lines: 220
    - path: "crates/lmlang-server/src/schema/autonomy_execution.rs"
      provides: "Execution outcome, per-action result, and terminal stop-reason schema types"
      min_lines: 150
    - path: "crates/lmlang-server/src/project_agent.rs"
      provides: "Session/transcript support for structured autonomous execution evidence and terminal reason storage"
      contains: "stop_reason"
    - path: "crates/lmlang-server/src/schema/mod.rs"
      provides: "Public export surface for autonomy execution schema"
      contains: "autonomy_execution"
  key_links:
    - from: "crates/lmlang-server/src/autonomy_executor.rs"
      to: "crates/lmlang-server/src/schema/autonomy_plan.rs"
      via: "Executor dispatch consumes validated AutonomyPlanAction variants directly from planner contract types"
      pattern: "AutonomyPlanAction|AutonomyPlanEnvelope"
    - from: "crates/lmlang-server/src/autonomy_executor.rs"
      to: "crates/lmlang-server/src/service.rs"
      via: "Executor action handlers call existing mutation/verify/compile/simulate/history/query primitives"
      pattern: "propose_edit|verify|compile|simulate|history|checkpoint|overview|search|semantic_query"
    - from: "crates/lmlang-server/src/project_agent.rs"
      to: "crates/lmlang-server/src/schema/autonomy_execution.rs"
      via: "Session/transcript stores and surfaces typed stop reason and action evidence fields"
      pattern: "StopReason|Execution"
---

<objective>
Build the generic executor foundation for phase-15 autonomous plan execution.

Purpose: Convert Phase 14 planner outputs into deterministic server operations with typed execution evidence and explicit stop-reason taxonomy.
Output: New executor + schema modules and project-agent runtime support for machine-readable execution outcomes.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/15-generic-graph-build-executor/15-RESEARCH.md
@crates/lmlang-server/src/autonomy_planner.rs
@crates/lmlang-server/src/autonomous_runner.rs
@crates/lmlang-server/src/schema/autonomy_plan.rs
@crates/lmlang-server/src/service.rs
@crates/lmlang-server/src/project_agent.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement generic planner-action executor dispatch</name>
  <files>
    crates/lmlang-server/src/autonomy_executor.rs
    crates/lmlang-server/src/lib.rs
  </files>
  <action>
    Create an executor module that accepts a validated planner envelope and executes ordered actions against ProgramService primitives.
    Dispatch must cover: mutate_batch, verify, compile, simulate, inspect, and history.
    For each action, return typed action-level outcome records including index, kind, status, and concise result summary/error details.

    Enforce deterministic guardrails:
    - reject unsupported/ill-formed action payloads with explicit error classification
    - preserve existing mutation validation and commit semantics by routing through ProgramService APIs
    - avoid panics; normalize failures into structured executor errors.
  </action>
  <verify>
    `cargo test --package lmlang-server` passes with executor unit tests covering all action variants and at least one failure path per action family.
  </verify>
  <done>
    Planner action lists are executable by a reusable deterministic executor component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define execution evidence + terminal stop reason schema and session integration</name>
  <files>
    crates/lmlang-server/src/schema/autonomy_execution.rs
    crates/lmlang-server/src/schema/mod.rs
    crates/lmlang-server/src/project_agent.rs
  </files>
  <action>
    Introduce schema types for:
    - per-action execution result records
    - attempt summaries
    - terminal stop reason codes and details
    - top-level execution outcome payloads

    Extend project-agent session/transcript surfaces to store and append these outcomes so operators can inspect why a run ended.
    Keep storage/backward compatibility behavior safe for existing run/chat flows.
  </action>
  <verify>
    Session-level unit tests (or focused integration tests) confirm stop reason codes and action evidence can be appended/retrieved without breaking existing transcript behavior.
  </verify>
  <done>
    AUT-06 groundwork exists as typed runtime evidence rather than free-form text only.
  </done>
</task>

</tasks>

<verification>
1. `autonomy_executor.rs` exists and dispatches every Phase 14 action variant
2. Action execution results are typed with deterministic status and detail fields
3. Stop reason enum/code taxonomy exists and is exported through schema module
4. Project-agent session can persist and surface structured terminal reason/evidence fields
5. Existing phase14 planner parsing/validation tests remain green
</verification>

<success_criteria>
- AUT-04 foundation complete: generic planner actions are executable through deterministic server logic
- AUT-06 foundation complete: terminal reasons/evidence have machine-readable schema support
- Phase 15 loop integration (15-02) can consume executor + typed outcomes directly
</success_criteria>

<output>
After completion, create `.planning/phases/15-generic-graph-build-executor/15-01-SUMMARY.md`
</output>
