---
phase: 16-verify-compile-repair-loop
plan: 02
type: execute
wave: 2
depends_on:
  - "16-01"
files_modified:
  - crates/lmlang-server/src/autonomous_runner.rs
  - crates/lmlang-server/src/autonomy_planner.rs
  - crates/lmlang-server/src/project_agent.rs
  - crates/lmlang-server/src/schema/agent_control.rs
  - crates/lmlang-server/src/schema/dashboard.rs
  - crates/lmlang-server/src/handlers/agent_control.rs
  - crates/lmlang-server/src/handlers/dashboard.rs
autonomous: true
requirements:
  - AUT-07
  - AUT-08

must_haves:
  truths:
    - "Replanning receives deterministic structured feedback from the latest failed verify/compile attempt"
    - "Planner prompts include compact diagnostics context rather than relying only on free-form transcript notes"
    - "Retry transitions remain bounded and explicit while enabling targeted repair behavior"
    - "Unsafe or non-retryable repair situations exit cleanly with explicit stop reason details"
  artifacts:
    - path: "crates/lmlang-server/src/autonomy_planner.rs"
      provides: "Planner prompt contract extended with diagnostics-aware repair context section"
      contains: "Latest execution diagnostics"
    - path: "crates/lmlang-server/src/autonomous_runner.rs"
      provides: "Replan loop wiring that passes latest attempt diagnostics into planner calls"
      min_lines: 320
    - path: "crates/lmlang-server/src/project_agent.rs"
      provides: "Session helpers for retrieving most-recent diagnostics-rich attempt context"
      contains: "execution_attempts"
    - path: "crates/lmlang-server/src/schema/agent_control.rs"
      provides: "Agent chat execution projection includes diagnostics summary metadata for latest attempt"
      contains: "diagnostics"
    - path: "crates/lmlang-server/src/schema/dashboard.rs"
      provides: "Dashboard chat execution projection includes diagnostics summary metadata"
      contains: "diagnostics"
  key_links:
    - from: "crates/lmlang-server/src/autonomous_runner.rs"
      to: "crates/lmlang-server/src/autonomy_planner.rs"
      via: "Runner passes repair context into planner prompt generation for next attempt"
      pattern: "plan_for_prompt|diagnostic|attempt"
    - from: "crates/lmlang-server/src/autonomous_runner.rs"
      to: "crates/lmlang-server/src/project_agent.rs"
      via: "Runner derives latest failed-attempt diagnostics from session evidence before replanning"
      pattern: "execution_attempts|append_execution_attempt|set_execution_outcome"
    - from: "crates/lmlang-server/src/handlers/dashboard.rs"
      to: "crates/lmlang-server/src/schema/dashboard.rs"
      via: "Dashboard chat response includes diagnostics-oriented execution metadata"
      pattern: "execution|diagnostics|stop_reason"
---

<objective>
Integrate targeted repair behavior into the bounded autonomous loop.

Purpose: Feed verify/compile diagnostics into planner retries so replans are focused, deterministic, and bounded.
Output: Diagnostics-aware planner prompts and loop transitions with explicit unsafe/non-retryable exits.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/16-verify-compile-repair-loop/16-RESEARCH.md
@.planning/phases/16-verify-compile-repair-loop/16-01-PLAN.md
@crates/lmlang-server/src/autonomous_runner.rs
@crates/lmlang-server/src/autonomy_planner.rs
@crates/lmlang-server/src/project_agent.rs
@crates/lmlang-server/src/schema/agent_control.rs
@crates/lmlang-server/src/schema/dashboard.rs
@crates/lmlang-server/src/handlers/agent_control.rs
@crates/lmlang-server/src/handlers/dashboard.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend planner prompt path with structured repair diagnostics context</name>
  <files>
    crates/lmlang-server/src/autonomy_planner.rs
    crates/lmlang-server/src/autonomous_runner.rs
    crates/lmlang-server/src/project_agent.rs
  </files>
  <action>
    Add a diagnostics context payload passed from runner to planner on retries.
    Prompt content should include concise machine-readable summaries of latest verify/compile failures (action kind, error class, key diagnostics, retry position) and explicit instruction to produce targeted repair steps.
    Ensure first-attempt prompts remain minimal and existing planner contract validation behavior remains unchanged.
  </action>
  <verify>
    Unit tests assert planner prompt assembly includes diagnostics block on retries and omits it on clean first attempts.
  </verify>
  <done>
    Replanning is informed by concrete verify/compile diagnostics instead of generic retry text.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement targeted repair transition behavior and surface diagnostics metadata</name>
  <files>
    crates/lmlang-server/src/autonomous_runner.rs
    crates/lmlang-server/src/schema/agent_control.rs
    crates/lmlang-server/src/schema/dashboard.rs
    crates/lmlang-server/src/handlers/agent_control.rs
    crates/lmlang-server/src/handlers/dashboard.rs
  </files>
  <action>
    Refine loop behavior so verify/compile failure classes map to explicit targeted-repair retry notes and clear terminal outcomes when retries are exhausted or conditions are unsafe.
    Project compact diagnostics metadata on agent and dashboard chat responses to aid operator triage without requiring full raw logs.
    Maintain optional-field compatibility for existing clients.
  </action>
  <verify>
    Focused tests confirm retryable verify/compile failures re-enter planner with diagnostics context, and non-retryable/unsafe cases terminate with explicit stable stop reasons.
  </verify>
  <done>
    AUT-07 and AUT-08 loop behavior is fully integrated and operator-visible.
  </done>
</task>

</tasks>

<verification>
1. Planner prompt path accepts and renders structured diagnostics context for retry attempts
2. Retry loop transitions for verify/compile failures remain deterministic under max-attempt budget
3. Targeted repair behavior is observable via attempt notes and execution metadata fields
4. Non-retryable/unsafe conditions terminate cleanly with explicit stop reason details
5. Agent/dashboard response contracts stay backward-compatible (new fields optional)
</verification>

<success_criteria>
- AUT-07 satisfied: verification diagnostics feed directly into subsequent planning decisions
- AUT-08 satisfied: compile/run diagnostics trigger targeted repair iterations rather than blind retries
- Phase 16 runtime behavior is ready for integration-level validation in 16-03
</success_criteria>

<output>
After completion, create `.planning/phases/16-verify-compile-repair-loop/16-02-SUMMARY.md`
</output>
