---
phase: 16-verify-compile-repair-loop
plan: 03
type: execute
wave: 3
depends_on:
  - "16-01"
  - "16-02"
files_modified:
  - crates/lmlang-server/tests/integration_test.rs
  - docs/api/operator-endpoints.md
  - crates/lmlang-server/src/autonomy_planner.rs
autonomous: true
requirements:
  - AUT-07
  - AUT-08

must_haves:
  truths:
    - "Phase16 verify/compile repair behavior is protected by deterministic integration tests using mock planner interactions"
    - "Tests assert that retry planner requests include diagnostics context derived from prior failures"
    - "Compile and verify failure scenarios are validated for both retry continuation and terminal exhaustion paths"
    - "Operator-facing docs explain diagnostics-driven repair behavior and how to interpret response metadata"
  artifacts:
    - path: "crates/lmlang-server/tests/integration_test.rs"
      provides: "phase16_* coverage for diagnostics feedback chaining, compile-repair retries, and terminal outcomes"
      contains: "phase16"
    - path: "docs/api/operator-endpoints.md"
      provides: "Updated operator contract docs for diagnostics metadata and targeted repair loop behavior"
      contains: "AUT-08"
    - path: "crates/lmlang-server/src/autonomy_planner.rs"
      provides: "Prompt contract comments/examples aligned with tested diagnostics-context format"
      contains: "Latest execution diagnostics"
  key_links:
    - from: "crates/lmlang-server/tests/integration_test.rs"
      to: "crates/lmlang-server/src/autonomous_runner.rs"
      via: "Integration tests assert retry transitions and terminal stop reasons for verify/compile repair scenarios"
      pattern: "start|wait_for_run_status|stop_reason|retry"
    - from: "crates/lmlang-server/tests/integration_test.rs"
      to: "crates/lmlang-server/src/autonomy_planner.rs"
      via: "Mock planner request assertions verify diagnostics context is included on replanning attempts"
      pattern: "requests|diagnostics|attempt"
    - from: "docs/api/operator-endpoints.md"
      to: "crates/lmlang-server/src/schema/agent_control.rs"
      via: "Published execution metadata examples match diagnostics fields exposed by APIs"
      pattern: "execution|diagnostics|stop_reason"
---

<objective>
Harden and document diagnostics-driven repair loop behavior for phase16.

Purpose: Lock AUT-07/AUT-08 behavior with end-to-end assertions and operator contract documentation.
Output: Deterministic phase16 integration tests plus updated API docs for diagnostics-aware retries.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/16-verify-compile-repair-loop/16-RESEARCH.md
@.planning/phases/16-verify-compile-repair-loop/16-01-PLAN.md
@.planning/phases/16-verify-compile-repair-loop/16-02-PLAN.md
@crates/lmlang-server/tests/integration_test.rs
@crates/lmlang-server/src/autonomous_runner.rs
@crates/lmlang-server/src/autonomy_planner.rs
@docs/api/operator-endpoints.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic integration coverage for verify/compile feedback chaining</name>
  <files>
    crates/lmlang-server/tests/integration_test.rs
  </files>
  <action>
    Add `phase16_*` integration tests that cover:
    - verify failure on attempt N leads to replanning request N+1 with diagnostics context
    - compile failure diagnostics trigger targeted repair retry and deterministic terminal state when unresolved
    - successful repair path transitions to `completed` with diagnostic history preserved

    Reuse mock planner server request-capture pattern to assert prompt/request contents without live provider dependencies.
  </action>
  <verify>
    `cargo test --package lmlang-server --test integration_test phase16_` passes with assertions on diagnostics feedback and stop-reason outcomes.
  </verify>
  <done>
    Phase16 repair-loop behavior is protected by deterministic end-to-end contract tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document diagnostics-driven repair loop behavior for operators</name>
  <files>
    docs/api/operator-endpoints.md
    crates/lmlang-server/src/autonomy_planner.rs
  </files>
  <action>
    Update operator docs with:
    - verify/compile diagnostics feedback flow across retries
    - response field examples for diagnostics metadata on chat endpoints
    - troubleshooting guidance for common repair-loop terminal outcomes

    Ensure prompt/contract comments in planner module reflect tested diagnostics-context format.
  </action>
  <verify>
    Docs and tests agree on diagnostics field names and representative stop reason behavior.
  </verify>
  <done>
    Operators can interpret phase16 autonomous repair attempts without inspecting internals.
  </done>
</task>

</tasks>

<verification>
1. `phase16_*` integration tests exist for verify-feedback retry and compile-feedback retry scenarios
2. Tests assert diagnostics context appears in captured planner requests after failed attempts
3. Terminal paths (success, retry exhaustion, non-retryable/unsafe) are asserted with explicit stop reason codes
4. Operator docs include accurate diagnostics metadata examples and troubleshooting guidance
5. Phase15 regression behavior remains covered (existing tests unchanged/green)
</verification>

<success_criteria>
- AUT-07 is test-backed at integration level for diagnostics feedback chaining
- AUT-08 is test-backed at integration level for compile-targeted repair retries
- Phase 16 is execution-ready with contract docs and regression protection
</success_criteria>

<output>
After completion, create `.planning/phases/16-verify-compile-repair-loop/16-03-SUMMARY.md`
</output>
