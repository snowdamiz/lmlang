---
phase: 16-verify-compile-repair-loop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/lmlang-server/src/autonomous_runner.rs
  - crates/lmlang-server/src/autonomy_executor.rs
  - crates/lmlang-server/src/schema/autonomy_execution.rs
  - crates/lmlang-server/src/project_agent.rs
  - crates/lmlang-server/src/schema/mod.rs
autonomous: true
requirements:
  - AUT-07
  - AUT-08

must_haves:
  truths:
    - "Autonomous attempts persist normalized verify and compile diagnostics in machine-readable execution evidence"
    - "Mutation-driven attempts capture verification feedback deterministically within the same attempt payload"
    - "Failure diagnostics retain retryability classification and enough detail for downstream targeted replanning"
    - "Session persistence remains backward-compatible while storing richer diagnostics context"
  artifacts:
    - path: "crates/lmlang-server/src/schema/autonomy_execution.rs"
      provides: "Extended execution attempt/result schema fields for normalized diagnostics payloads"
      contains: "diagnostics"
    - path: "crates/lmlang-server/src/autonomy_executor.rs"
      provides: "Executor-level verify/compile diagnostics normalization and capture for action outcomes"
      min_lines: 260
    - path: "crates/lmlang-server/src/autonomous_runner.rs"
      provides: "Attempt assembly that preserves diagnostic evidence for failed verify/compile paths"
      contains: "verify_gate"
    - path: "crates/lmlang-server/src/project_agent.rs"
      provides: "Session persistence for richer execution attempt diagnostics without transcript-only reliance"
      contains: "execution_attempts"
  key_links:
    - from: "crates/lmlang-server/src/autonomy_executor.rs"
      to: "crates/lmlang-server/src/schema/autonomy_execution.rs"
      via: "Executor emits normalized diagnostics fields into typed action/attempt evidence structures"
      pattern: "AutonomyActionExecutionResult|AutonomyExecutionError|detail|diagnostics"
    - from: "crates/lmlang-server/src/autonomous_runner.rs"
      to: "crates/lmlang-server/src/autonomy_executor.rs"
      via: "Runner consumes executor outcomes with diagnostics-rich action rows per attempt"
      pattern: "execute_plan|attempt|action_results|stop_reason"
    - from: "crates/lmlang-server/src/project_agent.rs"
      to: "crates/lmlang-server/src/schema/autonomy_execution.rs"
      via: "Session-level persistence stores and retrieves enriched attempt diagnostics"
      pattern: "AutonomyExecutionAttemptSummary|AutonomyExecutionOutcome"
---

<objective>
Implement the diagnostics-capture foundation for phase16 repair behavior.

Purpose: Persist deterministic verify/compile feedback in execution evidence so replanning can use concrete failure context.
Output: Extended execution schema and runtime capture path that preserves structured diagnostics per attempt.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/16-verify-compile-repair-loop/16-RESEARCH.md
@.planning/phases/15-generic-graph-build-executor/15-01-PLAN.md
@.planning/phases/15-generic-graph-build-executor/15-02-PLAN.md
@crates/lmlang-server/src/autonomous_runner.rs
@crates/lmlang-server/src/autonomy_executor.rs
@crates/lmlang-server/src/schema/autonomy_execution.rs
@crates/lmlang-server/src/project_agent.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Normalize and persist verify/compile diagnostics in execution evidence</name>
  <files>
    crates/lmlang-server/src/schema/autonomy_execution.rs
    crates/lmlang-server/src/autonomy_executor.rs
    crates/lmlang-server/src/schema/mod.rs
  </files>
  <action>
    Extend execution schema and helper constructors so action outcomes can carry normalized diagnostics metadata suitable for repair planning.
    Cover verify and compile failures explicitly, including machine-readable error class, retryability, and compact diagnostic summaries.
    Keep existing serialized field names stable where possible; add new fields as optional/compatible.
  </action>
  <verify>
    Unit tests confirm verify and compile failure paths emit deterministic diagnostics structure and preserve retryable classification.
  </verify>
  <done>
    Execution evidence is rich enough to power targeted repair prompts instead of generic retry notes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Carry diagnostics-rich attempt evidence through runner/session state</name>
  <files>
    crates/lmlang-server/src/autonomous_runner.rs
    crates/lmlang-server/src/project_agent.rs
  </files>
  <action>
    Update autonomous runner attempt construction so post-action verify/compile failures include normalized diagnostics in attempt summaries.
    Ensure project-agent persistence surfaces this richer evidence without regressing existing transcript behavior or stop-reason projections.
    Preserve deterministic fail-fast and retry transition semantics from phase15.
  </action>
  <verify>
    Focused tests validate attempt summaries written to session state include diagnostics for verify and compile failure scenarios.
  </verify>
  <done>
    Latest attempt diagnostics are durably available to the next planner iteration.
  </done>
</task>

</tasks>

<verification>
1. Verify and compile failure rows include normalized diagnostics details in typed action outcomes
2. Execution attempt summaries persist diagnostics context in session state
3. Existing stop reason codes remain stable for previously covered phase15 paths
4. Backward-compatible response serialization is preserved for clients that ignore new diagnostics fields
5. AUT-07/AUT-08 groundwork exists before planner feedback injection
</verification>

<success_criteria>
- AUT-07 foundation complete: automatic verification/diagnostic evidence is structured and persisted per attempt
- AUT-08 foundation complete: compile diagnostics are machine-readable and available for repair logic
- Phase 16-02 can consume diagnostics-rich attempt context for targeted replanning
</success_criteria>

<output>
After completion, create `.planning/phases/16-verify-compile-repair-loop/16-01-SUMMARY.md`
</output>
