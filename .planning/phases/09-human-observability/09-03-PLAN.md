---
phase: 09-human-observability
plan: 03
type: execute
wave: 3
depends_on:
  - "09-01"
  - "09-02"
files_modified:
  - crates/lmlang-server/src/schema/observability.rs
  - crates/lmlang-server/src/handlers/observability.rs
  - crates/lmlang-server/src/service.rs
  - crates/lmlang-server/static/observability/app.js
  - crates/lmlang-server/static/observability/styles.css
  - crates/lmlang-server/tests/integration_test.rs
  - .planning/phases/09-human-observability/09-VERIFICATION.md
autonomous: true
requirements:
  - VIZ-03
  - VIZ-04

must_haves:
  truths:
    - "NL query UI supports free-text entry plus suggested prompt chips"
    - "Ambiguous queries trigger a clarification prompt and expose top interpretations"
    - "Result payload returns contextual tabs: Summary, Relationships, Contracts"
    - "Graph selection and result context are bidirectionally synchronized"
    - "No-strong-match queries return nearest related subgraphs with explicit low-confidence signaling"
  artifacts:
    - path: "crates/lmlang-server/src/schema/observability.rs"
      provides: "Query response schema for interpretation candidates and contextual tab sections"
      contains: "summary|relationships|contracts"
    - path: "crates/lmlang-server/static/observability/app.js"
      provides: "Query panel UX, disambiguation flow, tab rendering, and graph-context sync"
      min_lines: 340
    - path: "crates/lmlang-server/tests/integration_test.rs"
      provides: "End-to-end tests for ambiguity handling, nearest fallback, and contextual response fields"
      min_lines: 380
    - path: ".planning/phases/09-human-observability/09-VERIFICATION.md"
      provides: "Requirement-to-evidence table for VIZ-01 through VIZ-04"
      min_lines: 80
  key_links:
    - from: "crates/lmlang-server/src/handlers/observability.rs"
      to: "crates/lmlang-server/src/service.rs"
      via: "Query endpoint invokes ranking/disambiguation and contextual packaging"
      pattern: "query|ambigu|context"
    - from: "crates/lmlang-server/static/observability/app.js"
      to: "crates/lmlang-server/src/schema/observability.rs"
      via: "Client renders Summary/Relationships/Contracts tabs from structured response"
      pattern: "summary|relationships|contracts"
    - from: "crates/lmlang-server/tests/integration_test.rs"
      to: ".planning/phases/09-human-observability/09-VERIFICATION.md"
      via: "Verification document cites concrete test evidence per requirement"
      pattern: "VIZ-0"
---

<objective>
Complete the natural-language observability experience with contextual tabs and graph-result synchronization.

Purpose: Fulfill VIZ-03 and VIZ-04 with robust disambiguation, nearest-match fallback, and context-rich result presentation.
Output: End-to-end query UX (free-text + chips + clarification) with synchronized graph highlighting and verification evidence.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-human-observability/09-CONTEXT.md
@.planning/phases/09-human-observability/09-RESEARCH.md
@.planning/phases/09-human-observability/09-01-SUMMARY.md
@.planning/phases/09-human-observability/09-02-SUMMARY.md
@crates/lmlang-server/src/service.rs
@crates/lmlang-server/src/handlers/observability.rs
@crates/lmlang-server/static/observability/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend query contracts for disambiguation and contextual tab payloads</name>
  <files>
    crates/lmlang-server/src/schema/observability.rs
    crates/lmlang-server/src/service.rs
    crates/lmlang-server/src/handlers/observability.rs
    crates/lmlang-server/tests/integration_test.rs
  </files>
  <action>
    Expand query request/response contracts to include:
    - suggested prompt chips metadata
    - ambiguity flag + interpretation candidates
    - confidence/score metadata and nearest-match fallback reason
    - contextual sections for Summary, Relationships, Contracts

    Ensure handlers return these structures directly from ProgramService and add end-to-end tests for disambiguation + fallback behavior.
  </action>
  <verify>
    `cargo test --package lmlang-server --test integration_test` passes with coverage for ambiguity and contextual response sections.
  </verify>
  <done>
    Query API can express all NL observability interaction states required by context and requirements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement query panel UX, context tabs, and bidirectional graph synchronization</name>
  <files>
    crates/lmlang-server/static/observability/app.js
    crates/lmlang-server/static/observability/styles.css
    .planning/phases/09-human-observability/09-VERIFICATION.md
  </files>
  <action>
    Implement the UI workflow:
    - free-text query input plus suggested chips
    - clarification interaction when ambiguity is flagged
    - tabbed contextual result rendering (Summary, Relationships, Contracts)
    - nearest-match fallback presentation with explicit low-confidence message
    - bidirectional sync: selecting graph node focuses context; selecting result highlights/focuses graph

    Record final requirement evidence in `09-VERIFICATION.md` with links to test coverage and manual checks.
  </action>
  <verify>
    Manual browser walkthrough plus integration tests validate query UX flows and synchronization behavior.
  </verify>
  <done>
    Humans can ask program questions and navigate contextual answers directly in synchronized graph and tab views.
  </done>
</task>

</tasks>

<verification>
1. Query panel supports both free-text and suggested prompt chips
2. Ambiguous queries return clarification candidates and can continue to resolved results
3. Low-confidence queries return nearest related nodes with explicit signaling
4. Results show Summary, Relationships, and Contracts tabs with meaningful content
5. Graph and result panels stay synchronized in both interaction directions
6. `09-VERIFICATION.md` maps VIZ-01..VIZ-04 to concrete test/manual evidence
</verification>

<success_criteria>
- Natural-language observability is usable end-to-end with robust ambiguity handling
- Result context is rich enough for human understanding of returned subgraphs
- Query and graph surfaces feel like one synchronized observability experience
</success_criteria>

<output>
After completion, create `.planning/phases/09-human-observability/09-03-SUMMARY.md`
</output>
