---
phase: 14-action-protocol-and-planner-contract
plan: 03
type: execute
wave: 3
depends_on:
  - "14-01"
  - "14-02"
files_modified:
  - crates/lmlang-server/src/schema/agent_control.rs
  - crates/lmlang-server/src/schema/dashboard.rs
  - crates/lmlang-server/tests/integration_test.rs
  - docs/api/operator-endpoints.md
autonomous: true
requirements:
  - AUT-01
  - AUT-02
  - AUT-03

must_haves:
  truths:
    - "Integration tests prove non-command prompts return structured planner outcomes"
    - "Structured failure paths are observable and include explicit reason codes"
    - "Contract tests cover multi-step plans beyond hello-world command patterns"
    - "Planner API documentation matches real response payload fields"
  artifacts:
    - path: "crates/lmlang-server/tests/integration_test.rs"
      provides: "End-to-end planner contract routing and validation regression coverage"
      contains: "phase14"
    - path: "crates/lmlang-server/src/schema/agent_control.rs"
      provides: "Typed response fields for planner status, actions, and failure reason"
      contains: "planner"
    - path: "crates/lmlang-server/src/schema/dashboard.rs"
      provides: "Dashboard AI chat response shape for planner outcomes"
      contains: "actions"
    - path: "docs/api/operator-endpoints.md"
      provides: "Operator-facing examples for planner success/failure payloads"
      contains: "AUT-01"
  key_links:
    - from: "crates/lmlang-server/tests/integration_test.rs"
      to: "crates/lmlang-server/src/handlers/agent_control.rs"
      via: "Integration tests verify planner routing in project-agent chat endpoint"
      pattern: "/agents/{}/chat|planner"
    - from: "crates/lmlang-server/tests/integration_test.rs"
      to: "crates/lmlang-server/src/handlers/dashboard.rs"
      via: "Integration tests verify dashboard AI chat planner payload behavior"
      pattern: "/dashboard/ai/chat"
    - from: "docs/api/operator-endpoints.md"
      to: "crates/lmlang-server/src/schema/agent_control.rs"
      via: "Published contract examples stay aligned with serialized response fields"
      pattern: "failure|actions|plan"
---

<objective>
Harden and verify Phase 14 planner contract behavior end-to-end.

Purpose: Lock in AUT-01..AUT-03 with integration coverage, explicit failure observability, and operator-facing API documentation.
Output: Contract-level integration tests and finalized response/docs alignment for planner success/failure flows.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/14-action-protocol-and-planner-contract/14-RESEARCH.md
@.planning/phases/14-action-protocol-and-planner-contract/14-01-PLAN.md
@.planning/phases/14-action-protocol-and-planner-contract/14-02-PLAN.md
@crates/lmlang-server/tests/integration_test.rs
@crates/lmlang-server/src/schema/agent_control.rs
@crates/lmlang-server/src/schema/dashboard.rs
@docs/api/operator-endpoints.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 14 integration tests for planner routing and validation outcomes</name>
  <files>
    crates/lmlang-server/tests/integration_test.rs
  </files>
  <action>
    Add integration tests that verify:
    - non-command prompt invokes planner path and returns structured plan metadata
    - invalid planner response returns structured failure reason (not plain fallback text)
    - explicit command prompts still follow deterministic hello-world path
    - multi-step plan fixture (2+ actions) is accepted by validation gate

    Prefer deterministic test doubles/fixtures so tests do not require live external model calls.
  </action>
  <verify>
    `cargo test --package lmlang-server --test integration_test` passes and includes new phase14_* cases.
  </verify>
  <done>
    Planner routing and validation behavior is guaranteed by end-to-end automated tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Finalize response contract + docs alignment for operator visibility</name>
  <files>
    crates/lmlang-server/src/schema/agent_control.rs
    crates/lmlang-server/src/schema/dashboard.rs
    docs/api/operator-endpoints.md
  </files>
  <action>
    Normalize response payload fields for planner outcomes so both project-agent chat and dashboard chat expose:
    - planner status
    - normalized action summary
    - structured failure reason code/message when planning fails

    Update API docs with request/response examples that match real schema and integration test assertions.
  </action>
  <verify>
    Contract docs examples match serialized schema fields exercised by integration tests.
  </verify>
  <done>
    Planner outcomes are transparent and operator-auditable in both API and dashboard-facing contracts.
  </done>
</task>

</tasks>

<verification>
1. Integration tests include phase14 planner routing + failure-path coverage
2. Non-command prompt behavior is contract-tested for structured outcomes
3. Deterministic hello-world command path regression remains green
4. Response schemas include planner metadata for both agent and dashboard chat APIs
5. Operator docs contain accurate success/failure payload examples
</verification>

<success_criteria>
- AUT-01 behavior is verified in end-to-end tests
- AUT-02 contract enforcement and failure reporting are test-backed
- AUT-03 multi-step plan support is demonstrated by acceptance-level fixture coverage
</success_criteria>

<output>
After completion, create `.planning/phases/14-action-protocol-and-planner-contract/14-03-SUMMARY.md`
</output>
