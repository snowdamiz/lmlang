---
phase: 14-action-protocol-and-planner-contract
plan: 02
type: execute
wave: 2
depends_on:
  - "14-01"
files_modified:
  - crates/lmlang-server/src/autonomy_planner.rs
  - crates/lmlang-server/src/lib.rs
  - crates/lmlang-server/src/llm_provider.rs
  - crates/lmlang-server/src/handlers/agent_control.rs
  - crates/lmlang-server/src/handlers/dashboard.rs
  - crates/lmlang-server/src/autonomous_runner.rs
  - crates/lmlang-server/src/schema/agent_control.rs
  - crates/lmlang-server/src/schema/dashboard.rs
autonomous: true
requirements:
  - AUT-01
  - AUT-02
  - AUT-03

must_haves:
  truths:
    - "Non-command natural-language prompts route through a planner contract path instead of plain chat fallback"
    - "Planner output is parsed and validated server-side before any execution intent is returned"
    - "Existing hello-world command behavior remains available for explicit command prompts"
    - "Handlers return structured planner outcomes (plan accepted or structured failure)"
  artifacts:
    - path: "crates/lmlang-server/src/autonomy_planner.rs"
      provides: "Planner invocation, response parsing, and validation orchestration"
      min_lines: 220
    - path: "crates/lmlang-server/src/handlers/agent_control.rs"
      provides: "Routing logic from chat prompts into deterministic command path vs planner path"
      contains: "planner"
    - path: "crates/lmlang-server/src/handlers/dashboard.rs"
      provides: "Dashboard AI chat integration for structured planner responses"
      contains: "actions"
    - path: "crates/lmlang-server/src/schema/agent_control.rs"
      provides: "Agent chat response fields for planner metadata and structured failure"
      contains: "plan"
  key_links:
    - from: "crates/lmlang-server/src/autonomy_planner.rs"
      to: "crates/lmlang-server/src/schema/autonomy_plan.rs"
      via: "Planner runtime validates provider output against versioned contract"
      pattern: "validate"
    - from: "crates/lmlang-server/src/handlers/agent_control.rs"
      to: "crates/lmlang-server/src/autonomy_planner.rs"
      via: "Agent chat uses planner path for non-command requests"
      pattern: "plan"
    - from: "crates/lmlang-server/src/handlers/dashboard.rs"
      to: "crates/lmlang-server/src/schema/dashboard.rs"
      via: "Dashboard chat response surfaces planner result metadata to UI"
      pattern: "actions|failure"
---

<objective>
Integrate planner contract routing into chat-first autonomy flows.

Purpose: Ensure natural-language build prompts become schema-valid action plans (or structured failures) before execution.
Output: Planner runtime module and handler integration across agent chat, dashboard chat, and autonomous loop entrypoints.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/14-action-protocol-and-planner-contract/14-RESEARCH.md
@.planning/phases/14-action-protocol-and-planner-contract/14-01-PLAN.md
@crates/lmlang-server/src/handlers/agent_control.rs
@crates/lmlang-server/src/handlers/dashboard.rs
@crates/lmlang-server/src/autonomous_runner.rs
@crates/lmlang-server/src/llm_provider.rs
@crates/lmlang-server/src/schema/agent_control.rs
@crates/lmlang-server/src/schema/dashboard.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build planner runtime adapter with strict validation handoff</name>
  <files>
    crates/lmlang-server/src/autonomy_planner.rs
    crates/lmlang-server/src/llm_provider.rs
    crates/lmlang-server/src/lib.rs
  </files>
  <action>
    Implement a planner runtime module that:
    - constructs planner prompts with contract/version expectations
    - obtains model output in JSON form
    - parses output into Phase 14 schema types
    - runs semantic validation and returns typed success/failure objects

    Extend provider client helpers as needed to support robust JSON-mode interactions while preserving existing plain-chat behavior.
  </action>
  <verify>
    Unit tests cover planner parse success, invalid JSON, unsupported version, and semantic validation rejection paths.
  </verify>
  <done>
    Planner output is no longer treated as unstructured text; it is typed and validated before use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Route non-command prompts through planner path in handlers</name>
  <files>
    crates/lmlang-server/src/handlers/agent_control.rs
    crates/lmlang-server/src/handlers/dashboard.rs
    crates/lmlang-server/src/autonomous_runner.rs
    crates/lmlang-server/src/schema/agent_control.rs
    crates/lmlang-server/src/schema/dashboard.rs
  </files>
  <action>
    Update request routing so:
    - explicit hello-world command prompts keep deterministic command handling
    - other natural-language build prompts invoke planner runtime
    - planner success returns structured action-plan metadata in API responses/transcript entries
    - planner failure returns explicit structured reason codes/messages (no silent free-form fallback)

    Keep autonomous loop behavior backward compatible while enabling planner-based next-step generation for non-command goals.
  </action>
  <verify>
    `cargo test --package lmlang-server --test integration_test` passes with updated route-level planner response assertions.
  </verify>
  <done>
    AUT-01 routing behavior is implemented: natural-language prompts now produce executable planner outcomes or explicit structured failure.
  </done>
</task>

</tasks>

<verification>
1. Planner runtime module exists and is wired from handlers
2. Non-command prompts no longer default to unstructured chat response path
3. Planner responses are validated before being surfaced as executable intent
4. Handler responses include structured planner success/failure metadata
5. Hello-world explicit command prompts still execute existing deterministic command workflow
</verification>

<success_criteria>
- AUT-01 satisfied for routing and structured planner outcomes
- AUT-02 enforced in runtime path (validation gate before execution intent)
- AUT-03 enabled with multi-step plan payload transport across APIs
</success_criteria>

<output>
After completion, create `.planning/phases/14-action-protocol-and-planner-contract/14-02-SUMMARY.md`
</output>
