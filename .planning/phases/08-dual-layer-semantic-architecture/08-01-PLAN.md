---
phase: 08-dual-layer-semantic-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/lmlang-core/src/node.rs
  - crates/lmlang-core/src/edge.rs
  - crates/lmlang-core/src/graph.rs
  - crates/lmlang-core/src/lib.rs
  - crates/lmlang-storage/src/convert.rs
  - crates/lmlang-storage/src/sqlite.rs
  - crates/lmlang-storage/src/schema.rs
  - crates/lmlang-server/src/schema/queries.rs
  - crates/lmlang-server/src/handlers/queries.rs
  - crates/lmlang-server/tests/integration_test.rs
autonomous: true
requirements:
  - DUAL-01
  - DUAL-07

must_haves:
  truths:
    - "Semantic graph schema supports module/function/type/spec/test/doc entities with provenance and ownership metadata"
    - "Embeddings are supported at semantic node level and semantic subgraph-summary level"
    - "ProgramGraph can persist and reload enriched semantic nodes and edges without data loss"
    - "Semantic summaries are deterministic for identical semantic subgraphs"
    - "Semantic query responses can include embeddings and summary metadata for retrieval workflows"
  artifacts:
    - path: "crates/lmlang-core/src/node.rs"
      provides: "Extended SemanticNode variants and metadata structs"
      min_lines: 220
    - path: "crates/lmlang-core/src/edge.rs"
      provides: "Extended SemanticEdge variants for intent/traceability relationships"
      min_lines: 90
    - path: "crates/lmlang-storage/src/convert.rs"
      provides: "Storage conversion logic for enriched semantic payloads and vectors"
      contains: "embedding"
    - path: "crates/lmlang-server/src/schema/queries.rs"
      provides: "API schema for semantic query payloads with summary + embedding fields"
      min_lines: 70
  key_links:
    - from: "crates/lmlang-core/src/graph.rs"
      to: "crates/lmlang-core/src/node.rs"
      via: "Semantic graph node creation and mutation APIs"
      pattern: "SemanticNode::"
    - from: "crates/lmlang-storage/src/sqlite.rs"
      to: "crates/lmlang-storage/src/convert.rs"
      via: "Persist/load enriched semantic entities"
      pattern: "semantic"
    - from: "crates/lmlang-server/src/handlers/queries.rs"
      to: "crates/lmlang-server/src/schema/queries.rs"
      via: "Structured semantic retrieval responses"
      pattern: "summary|embedding"
---

<objective>
Implement the enriched semantic layer and embedding infrastructure that Phase 8 propagation depends on.

Purpose: Upgrade the semantic graph from a structural skeleton into a durable knowledge layer used for synthesis, synchronization, and semantic retrieval.
Output: Extended semantic node/edge schema, storage persistence, and query payloads for node + subgraph embeddings and summaries.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dual-layer-semantic-architecture/08-CONTEXT.md
@.planning/phases/08-dual-layer-semantic-architecture/08-RESEARCH.md
@crates/lmlang-core/src/graph.rs
@crates/lmlang-core/src/node.rs
@crates/lmlang-core/src/edge.rs
@crates/lmlang-storage/src/convert.rs
@crates/lmlang-storage/src/sqlite.rs
@crates/lmlang-server/src/handlers/queries.rs
@crates/lmlang-server/src/schema/queries.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend semantic model for rich entities, metadata, and embeddings</name>
  <files>
    crates/lmlang-core/src/node.rs
    crates/lmlang-core/src/edge.rs
    crates/lmlang-core/src/graph.rs
    crates/lmlang-core/src/lib.rs
  </files>
  <action>
    Expand `SemanticNode` beyond `Module/Function/TypeDef` into a richer semantic model required by DUAL-01:
    - Add node variants for `Spec`, `Test`, and `Doc`.
    - Introduce shared metadata structs for ownership, provenance, and timestamp/version markers.
    - Add embedding payload support for:
      - node-level embedding vector
      - subgraph-summary embedding vector
    - Define deterministic summary payload fields (for later upward propagation updates).

    Extend `SemanticEdge` for richer relationships (examples: `Documents`, `Validates`, `Implements`, `DependsOn`) while preserving existing edge semantics.

    Add or update `ProgramGraph` helper methods for creating/updating enriched semantic entities without exposing raw graph mutability.
  </action>
  <verify>
    `cargo check --package lmlang-core` compiles. `cargo test --package lmlang-core` passes existing tests plus new semantic schema serde/roundtrip tests.
  </verify>
  <done>
    Core semantic types support all required entities and metadata, with embedding fields available in canonical model definitions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Persist enriched semantic payloads and expose retrieval shape</name>
  <files>
    crates/lmlang-storage/src/schema.rs
    crates/lmlang-storage/src/convert.rs
    crates/lmlang-storage/src/sqlite.rs
    crates/lmlang-server/src/schema/queries.rs
    crates/lmlang-server/src/handlers/queries.rs
    crates/lmlang-server/tests/integration_test.rs
  </files>
  <action>
    Update storage conversion and persistence paths to ensure enriched semantic nodes/edges and embedding vectors survive save/load roundtrips.

    Extend query schema/handlers so semantic retrieval includes:
    - entity kind + metadata
    - summary text payloads
    - embedding presence/shape (or opt-in embedding content field if already aligned with API policy)
    - relationship edge context for semantic navigation

    Add integration coverage for semantic persistence and retrieval:
    - create enriched semantic entities
    - persist + reload
    - verify deterministic summary payload equality and embedding integrity
  </action>
  <verify>
    `cargo test --package lmlang-storage` and `cargo test --package lmlang-server --test integration_test` pass.
  </verify>
  <done>
    Semantic knowledge entities are durable and retrievable with metadata + embedding context, completing the data foundation for propagation.
  </done>
</task>

</tasks>

<verification>
1. `cargo check --package lmlang-core` succeeds
2. `cargo test --package lmlang-core` passes with new semantic serde/roundtrip tests
3. `cargo test --package lmlang-storage` passes with enriched semantic persistence coverage
4. `cargo test --package lmlang-server --test integration_test` validates semantic retrieval payload shape
</verification>

<success_criteria>
- Semantic layer supports module/function/type/spec/test/doc entities with provenance/ownership metadata
- Semantic node and semantic subgraph-summary embeddings are represented in model + persisted through storage
- Retrieval APIs can expose semantic summaries and relationship context required for AI navigation
</success_criteria>

<output>
After completion, create `.planning/phases/08-dual-layer-semantic-architecture/08-01-SUMMARY.md`
</output>

