---
phase: 08-dual-layer-semantic-architecture
plan: 03
type: execute
wave: 3
depends_on:
  - "08-02"
files_modified:
  - crates/lmlang-core/src/graph.rs
  - crates/lmlang-core/src/error.rs
  - crates/lmlang-server/src/error.rs
  - crates/lmlang-server/src/schema/diagnostics.rs
  - crates/lmlang-server/src/schema/verify.rs
  - crates/lmlang-server/src/handlers/verify.rs
  - crates/lmlang-server/src/service.rs
  - crates/lmlang-server/tests/integration_test.rs
  - crates/lmlang-server/tests/concurrency.rs
  - .planning/phases/08-dual-layer-semantic-architecture/08-VERIFICATION.md
autonomous: true
requirements:
  - DUAL-04
  - DUAL-06
  - DUAL-07

must_haves:
  truths:
    - "Conflict handling uses deterministic rule-priority classes, not last-writer-wins"
    - "Unresolvable cross-layer conflicts produce structured diagnostics with actionable detail"
    - "Identical event sequences always converge to identical final semantic and compute graph states"
    - "Embedding refresh is scoped to changed semantic nodes and impacted subgraph summaries"
    - "End-to-end tests prove stable behavior under overlapping semantic and compute edits"
  artifacts:
    - path: "crates/lmlang-core/src/graph.rs"
      provides: "Conflict precedence table and resolver integrated into propagation flush"
      contains: "priority|precedence|conflict"
    - path: "crates/lmlang-server/src/schema/diagnostics.rs"
      provides: "Structured dual-layer conflict diagnostics schema"
      min_lines: 60
    - path: "crates/lmlang-server/tests/integration_test.rs"
      provides: "E2E deterministic sync and conflict-resolution regression suite"
      min_lines: 220
    - path: ".planning/phases/08-dual-layer-semantic-architecture/08-VERIFICATION.md"
      provides: "Phase-level proof table for DUAL-04/06/07 outcomes"
      min_lines: 80
  key_links:
    - from: "crates/lmlang-core/src/graph.rs"
      to: "crates/lmlang-server/src/service.rs"
      via: "Propagation flush uses conflict resolver and returns diagnostics"
      pattern: "conflict|flush"
    - from: "crates/lmlang-server/src/error.rs"
      to: "crates/lmlang-server/src/schema/diagnostics.rs"
      via: "ApiError payload for unresolved propagation conflicts"
      pattern: "Diagnostic|Conflict"
    - from: "crates/lmlang-server/tests/concurrency.rs"
      to: "crates/lmlang-server/src/handlers/verify.rs"
      via: "Concurrent/overlapping edit cases trigger deterministic resolution path"
      pattern: "flush|verify"
---

<objective>
Finalize Phase 8 with deterministic conflict resolution, scoped embedding refresh, and comprehensive end-to-end synchronization validation.

Purpose: Guarantee trustworthy dual-layer behavior under overlapping edits and cross-layer contention, with explicit diagnostics when rule priority cannot resolve safely.
Output: Rule-priority resolver, diagnostic surfaces, and regression coverage proving deterministic convergence and scoped embedding updates.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dual-layer-semantic-architecture/08-CONTEXT.md
@.planning/phases/08-dual-layer-semantic-architecture/08-RESEARCH.md
@.planning/phases/08-dual-layer-semantic-architecture/08-01-SUMMARY.md
@.planning/phases/08-dual-layer-semantic-architecture/08-02-SUMMARY.md
@crates/lmlang-core/src/graph.rs
@crates/lmlang-server/src/service.rs
@crates/lmlang-server/src/error.rs
@crates/lmlang-server/src/schema/diagnostics.rs
@crates/lmlang-server/src/handlers/verify.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rule-priority conflict resolver and diagnostics</name>
  <files>
    crates/lmlang-core/src/graph.rs
    crates/lmlang-core/src/error.rs
    crates/lmlang-server/src/error.rs
    crates/lmlang-server/src/schema/diagnostics.rs
    crates/lmlang-server/src/schema/verify.rs
    crates/lmlang-server/src/handlers/verify.rs
    crates/lmlang-server/src/service.rs
  </files>
  <action>
    Implement a deterministic precedence table for propagation conflict classes:
    - semantic-authoritative
    - compute-authoritative
    - mergeable
    - diagnostic-required

    Integrate resolver decisions into flush execution so conflict outcomes are stable and reproducible.

    For unresolved/ambiguous conflicts, emit structured diagnostics containing:
    - event ids and participating node references
    - attempted resolution class and why it failed
    - recommended remediation action for agents (retry strategy, required semantic correction, or manual intervention)

    Expose diagnostic payloads through server schema and API error mapping.
  </action>
  <verify>
    `cargo check --package lmlang-core` and `cargo check --package lmlang-server` compile with resolver + diagnostic wiring.
  </verify>
  <done>
    Conflict resolution behavior is deterministic and transparent, with structured diagnostics instead of silent drops.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate deterministic E2E sync and scoped embedding refresh</name>
  <files>
    crates/lmlang-server/tests/integration_test.rs
    crates/lmlang-server/tests/concurrency.rs
    .planning/phases/08-dual-layer-semantic-architecture/08-VERIFICATION.md
  </files>
  <action>
    Add regression tests for:
    - overlapping semantic + compute edits resolved by precedence rules
    - unresolved conflict path returns diagnostic payload
    - repeated identical event sequences converge to identical final state
    - embedding regeneration occurs only for changed semantic nodes and impacted subgraph summaries

    Record verification evidence in `08-VERIFICATION.md` mapping each DUAL requirement to explicit test cases and outcomes.
  </action>
  <verify>
    `cargo test --package lmlang-server --test integration_test` and `cargo test --package lmlang-server --test concurrency` pass.
  </verify>
  <done>
    End-to-end validation proves deterministic convergence, conflict transparency, and scoped embedding updates.
  </done>
</task>

</tasks>

<verification>
1. Rule-priority resolver executes during flush and produces stable outcomes
2. Unresolved conflicts return structured diagnostics through API responses
3. Replayed event sequences produce identical graph end states
4. Embedding refresh only touches changed semantic regions and derived summaries
5. `08-VERIFICATION.md` documents evidence for DUAL-04/06/07
</verification>

<success_criteria>
- Conflict handling follows deterministic precedence rules
- Ambiguous conflicts are surfaced with actionable diagnostics
- Dual-layer synchronization remains deterministic under overlapping edits
- Embedding refresh remains scoped to impacted semantic regions
</success_criteria>

<output>
After completion, create `.planning/phases/08-dual-layer-semantic-architecture/08-03-SUMMARY.md`
</output>

