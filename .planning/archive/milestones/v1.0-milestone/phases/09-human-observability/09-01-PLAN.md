---
phase: 09-human-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/lmlang-server/src/schema/observability.rs
  - crates/lmlang-server/src/schema/mod.rs
  - crates/lmlang-server/src/service.rs
  - crates/lmlang-core/src/graph.rs
  - crates/lmlang-server/tests/integration_test.rs
autonomous: true
requirements:
  - VIZ-01
  - VIZ-02
  - VIZ-03

must_haves:
  truths:
    - "Observability graph API returns an interactive DAG projection with node op kinds, typed edges, and function-boundary grouping metadata"
    - "Graph payload explicitly marks layer membership (semantic vs compute) and cross-layer links"
    - "Natural-language observability query produces ranked candidates using semantic embeddings and relationship context"
    - "Ambiguous NL queries return clarifying interpretations instead of silent guessing"
    - "Low-confidence NL queries return nearest related nodes as fallback instead of empty results"
  artifacts:
    - path: "crates/lmlang-server/src/schema/observability.rs"
      provides: "Request/response DTOs for graph projection and NL observability query"
      min_lines: 140
    - path: "crates/lmlang-server/src/service.rs"
      provides: "ProgramService observability projection + ranking/ambiguity/fallback logic"
      contains: "observability"
    - path: "crates/lmlang-server/tests/integration_test.rs"
      provides: "API-level tests for graph projection payload shape and NL query ranking behavior"
      min_lines: 320
    - path: "crates/lmlang-core/src/graph.rs"
      provides: "Core traversal helpers for function boundaries/layer projection"
      contains: "semantic|compute"
  key_links:
    - from: "crates/lmlang-server/src/service.rs"
      to: "crates/lmlang-server/src/schema/observability.rs"
      via: "Service outputs stable graph/query payloads consumed by handlers/UI"
      pattern: "GraphView|QueryResult"
    - from: "crates/lmlang-server/src/service.rs"
      to: "crates/lmlang-core/src/graph.rs"
      via: "Observability projection traverses dual-layer graph structure"
      pattern: "semantic|compute|function"
    - from: "crates/lmlang-server/tests/integration_test.rs"
      to: "crates/lmlang-server/src/service.rs"
      via: "Integration tests validate ranking, ambiguity, and fallback behavior"
      pattern: "ambigu|fallback|rank"
---

<objective>
Create the backend observability contract: graph projection payloads plus NL query ranking/ambiguity behavior.

Purpose: Establish a stable data plane that the visualization and query UX can depend on.
Output: New observability DTOs and ProgramService methods for graph rendering data and contextual NL retrieval.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-human-observability/09-CONTEXT.md
@.planning/phases/09-human-observability/09-RESEARCH.md
@crates/lmlang-server/src/service.rs
@crates/lmlang-server/src/schema/queries.rs
@crates/lmlang-core/src/graph.rs
@crates/lmlang-core/src/node.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add observability graph projection schema and service builders</name>
  <files>
    crates/lmlang-server/src/schema/observability.rs
    crates/lmlang-server/src/schema/mod.rs
    crates/lmlang-server/src/service.rs
    crates/lmlang-core/src/graph.rs
  </files>
  <action>
    Introduce observability-specific graph DTOs that include:
    - node identity + labels/op kind
    - typed edge payloads
    - function-boundary grouping metadata
    - explicit layer identity and cross-layer relationship markers

    Implement ProgramService projection methods that assemble these DTOs from ProgramGraph in deterministic order for stable rendering and test snapshots.
  </action>
  <verify>
    `cargo check --package lmlang-server` and targeted unit coverage for projection ordering/layer annotations pass.
  </verify>
  <done>
    Service can emit a complete observability graph payload suitable for interactive rendering with layer differentiation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement NL observability ranking, ambiguity handling, and nearest fallback</name>
  <files>
    crates/lmlang-server/src/schema/observability.rs
    crates/lmlang-server/src/service.rs
    crates/lmlang-server/tests/integration_test.rs
  </files>
  <action>
    Add a natural-language observability query method that:
    - scores/ranks semantic candidates using embeddings + relationship context
    - emits ambiguity diagnostics with top interpretations when score deltas are small
    - falls back to nearest related nodes when confidence is below threshold

    Return stable node IDs and lightweight context stubs to be expanded in Phase 09-03 tabs.
    Add integration tests covering ranked, ambiguous, and low-confidence fallback scenarios.
  </action>
  <verify>
    `cargo test --package lmlang-server --test integration_test` passes with new observability query cases.
  </verify>
  <done>
    Backend query behavior satisfies Phase-9 ambiguity and fallback UX constraints.
  </done>
</task>

</tasks>

<verification>
1. Observability graph payload includes layer identity, typed edges, and function-boundary grouping data
2. Projection ordering is deterministic across repeated calls
3. NL queries return ranked results with ambiguity metadata when needed
4. Low-confidence queries return nearest related nodes instead of empty results
5. `cargo test --package lmlang-server --test integration_test` covers all above paths
</verification>

<success_criteria>
- Backend contract exists for both graph rendering and NL observability queries
- Layer differentiation metadata is explicit and machine-consumable
- Ambiguity and fallback query behavior is deterministic and test-backed
</success_criteria>

<output>
After completion, create `.planning/phases/09-human-observability/09-01-SUMMARY.md`
</output>
