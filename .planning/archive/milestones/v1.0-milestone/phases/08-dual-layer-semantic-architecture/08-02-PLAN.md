---
phase: 08-dual-layer-semantic-architecture
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
files_modified:
  - crates/lmlang-core/src/graph.rs
  - crates/lmlang-core/src/error.rs
  - crates/lmlang-core/src/lib.rs
  - crates/lmlang-server/src/service.rs
  - crates/lmlang-server/src/schema/mutations.rs
  - crates/lmlang-server/src/schema/verify.rs
  - crates/lmlang-server/src/handlers/mutations.rs
  - crates/lmlang-server/src/handlers/verify.rs
  - crates/lmlang-server/src/router.rs
  - crates/lmlang-server/tests/integration_test.rs
autonomous: true
requirements:
  - DUAL-04
  - DUAL-05
  - DUAL-06

must_haves:
  truths:
    - "Bidirectional propagation is event-queue based with explicit flush semantics"
    - "Hybrid trigger behavior is implemented: local edits enqueue immediately, reconciliation occurs on flush"
    - "Semantic edits propagate downward into compute graph updates for function creation/signature/contract changes"
    - "Compute edits propagate upward into semantic summaries, relationship updates, and complexity metadata"
    - "Propagation flush is deterministic and idempotent for unchanged queues"
    - "Loop prevention prevents infinite cross-layer ping-pong"
  artifacts:
    - path: "crates/lmlang-core/src/graph.rs"
      provides: "Propagation queue/event types, enqueue API, flush executor"
      min_lines: 260
    - path: "crates/lmlang-server/src/service.rs"
      provides: "Service-level propagation orchestration and flush entrypoints"
      contains: "flush"
    - path: "crates/lmlang-server/src/handlers/mutations.rs"
      provides: "Mutation hooks that enqueue propagation events"
      contains: "enqueue"
    - path: "crates/lmlang-server/src/handlers/verify.rs"
      provides: "Explicit flush endpoint integration for agent workflow control"
      min_lines: 60
  key_links:
    - from: "crates/lmlang-server/src/handlers/mutations.rs"
      to: "crates/lmlang-server/src/service.rs"
      via: "Mutation application enqueues semantic/compute propagation events"
      pattern: "enqueue|propagation"
    - from: "crates/lmlang-server/src/service.rs"
      to: "crates/lmlang-core/src/graph.rs"
      via: "Flush delegates to deterministic queue executor"
      pattern: "flush"
    - from: "crates/lmlang-server/src/router.rs"
      to: "crates/lmlang-server/src/handlers/verify.rs"
      via: "Explicit propagation flush API route"
      pattern: "flush|verify"
---

<objective>
Build the queue-based hybrid bidirectional propagation engine and wire it into mutation/verification workflows with explicit flush control.

Purpose: Satisfy DUAL-04/05/06 by making semantic and compute layers stay synchronized without immediate recursive updates or nondeterministic behavior.
Output: Deterministic propagation queue with enqueue + flush APIs, mutation hooks, and test-backed downward/upward propagation behavior.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dual-layer-semantic-architecture/08-CONTEXT.md
@.planning/phases/08-dual-layer-semantic-architecture/08-RESEARCH.md
@.planning/phases/08-dual-layer-semantic-architecture/08-01-SUMMARY.md
@crates/lmlang-core/src/graph.rs
@crates/lmlang-server/src/service.rs
@crates/lmlang-server/src/handlers/mutations.rs
@crates/lmlang-server/src/handlers/verify.rs
@crates/lmlang-server/src/schema/mutations.rs
@crates/lmlang-server/src/schema/verify.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement deterministic propagation queue and flush executor</name>
  <files>
    crates/lmlang-core/src/graph.rs
    crates/lmlang-core/src/error.rs
    crates/lmlang-core/src/lib.rs
  </files>
  <action>
    Add a propagation subsystem in core with:
    - Event kinds for semantic->compute and compute->semantic updates.
    - Event envelope metadata (event id, origin layer, causal lineage, sequence/order key).
    - Queue APIs: enqueue, inspect pending, flush cycle execution.
    - Deterministic ordering strategy for flush (stable priority + insertion order).
    - Loop/idempotency guards (lineage set + bounded replay limit) to avoid infinite cycles.

    Add explicit propagation errors/diagnostics for invalid transforms and guard-triggered halts.
  </action>
  <verify>
    `cargo test --package lmlang-core` includes queue ordering, idempotency, and loop-termination cases.
  </verify>
  <done>
    Core exposes a deterministic, explicit-flush propagation engine ready for server integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate propagation into mutations and explicit flush API</name>
  <files>
    crates/lmlang-server/src/service.rs
    crates/lmlang-server/src/schema/mutations.rs
    crates/lmlang-server/src/schema/verify.rs
    crates/lmlang-server/src/handlers/mutations.rs
    crates/lmlang-server/src/handlers/verify.rs
    crates/lmlang-server/src/router.rs
    crates/lmlang-server/tests/integration_test.rs
  </files>
  <action>
    Wire hybrid trigger behavior:
    - Mutation handlers enqueue targeted propagation events as part of edit application.
    - Add service methods to run explicit propagation flush and return structured flush diagnostics.
    - Add/extend endpoint(s) so agents can invoke flush at predictable workflow boundaries.

    Cover both directions:
    - Downward propagation examples: semantic function creation, signature changes, contract additions.
    - Upward propagation examples: compute edits updating semantic summary text, relationship edges, and complexity metadata.

    Ensure repeated flush on unchanged queue is no-op/idempotent.
  </action>
  <verify>
    `cargo test --package lmlang-server --test integration_test` covers enqueue, flush, downward propagation, upward propagation, and idempotent re-flush behavior.
  </verify>
  <done>
    Server workflows support explicit and deterministic cross-layer synchronization through queue-based flush.
  </done>
</task>

</tasks>

<verification>
1. `cargo test --package lmlang-core` verifies deterministic queue processing and loop safety
2. `cargo test --package lmlang-server --test integration_test` proves downward and upward propagation behavior
3. Explicit flush endpoint/API is reachable and returns structured outcome data
4. Repeated flush with unchanged queue is stable and no-op
</verification>

<success_criteria>
- Queue-based event propagation with explicit flush semantics is implemented
- Hybrid trigger model is honored (auto-enqueue + explicit reconciliation flush)
- Semantic->compute and compute->semantic propagation scenarios both execute correctly
- Flush behavior is deterministic, idempotent on unchanged state, and loop-safe
</success_criteria>

<output>
After completion, create `.planning/phases/08-dual-layer-semantic-architecture/08-02-SUMMARY.md`
</output>

